---
const { emisor, firma, cliente } = Astro.props;
---

<div
  class="action-container my-12 p-8 bg-gray-50 rounded-xl border border-gray-200 shadow-sm font-mono"
>
  <h3 class="text-xl font-bold mb-6 text-gray-800">Firmar Documento</h3>
  <p class="mb-6 text-gray-600">
    Por favor, complete sus datos para firmar este documento y aceptar los
    términos estipulados a nombre de <strong class=""
      >{cliente?.nombre || "el Cliente"}</strong
    >.
  </p>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
    <!-- Left Column: Form -->
    <form id="sign-form" class="space-y-4">
      <div>
        <label for="signer-name" class="block font-medium text-gray-700 mb-1"
          >Nombre Completo</label
        >
        <input
          type="text"
          id="signer-name"
          required
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-core-primary focus:border-core-primary transition-colors"
          placeholder="Juan Pérez"
        />
      </div>

      <div>
        <label for="signer-email" class="block font-medium text-gray-700 mb-1"
          >Correo Electrónico</label
        >
        <input
          type="email"
          id="signer-email"
          required
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-core-primary focus:border-core-primary transition-colors"
          placeholder="juan@ejemplo.com"
        />
      </div>

      <div>
        <label for="signer-phone" class="block font-medium text-gray-700 mb-1"
          >Teléfono</label
        >
        <input
          type="tel"
          id="signer-phone"
          required
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-core-primary focus:border-core-primary transition-colors"
          placeholder="+56 9 1234 5678"
        />
      </div>
    </form>

    <!-- Right Column: Signature Preview -->
    <div class="flex flex-col h-full">
      <div
        class="flex-grow flex items-center justify-center border-2 border-dashed border-gray-300 rounded-xl bg-white p-8 min-h-[200px]"
      >
        <div
          id="signature-preview"
          class="font-signature text-5xl text-core-dark text-center break-words w-full"
        >
          <!-- Dynamic signature will appear here -->
          <span class="text-gray-300 text-2xl font-mono opacity-50 select-none"
            >Su firma aquí</span
          >
        </div>
      </div>
    </div>
  </div>

  <div class="mt-8">
    <button
      id="btn-sign"
      class="sign-button w-full bg-core-primary text-white font-semibold px-6 py-3 rounded-lg hover:opacity-90 transition-all shadow-md disabled:opacity-50 disabled:cursor-not-allowed"
    >
      Aceptar y Firmar
    </button>
  </div>
</div>

<style>
  /* Ensure font-signature is available or use fallback */
  .font-signature {
    font-family: var(--font-signature, "Mrs Saint Delafield", cursive);
  }
</style>

<script>
  // @ts-nocheck
  // Función para recolectar datos del usuario
  const collectFingerprint = async () => {
    // ... (existing fingerprint logic)
    const fingerprint = {
      timestamp: new Date().toISOString(),
      userAgent: navigator.userAgent,
      language: navigator.language,
      platform: navigator.platform,
      screen: `${window.screen.width}x${window.screen.height}`,
      ip: null,
      location: null,
      location_ip: null,
    };

    try {
      const ipResponse = await fetch("https://ipwho.is/");
      const ipData = await ipResponse.json();
      if (ipData.success) {
        fingerprint.ip = ipData.ip;
        fingerprint.location_ip = {
          city: ipData.city,
          region: ipData.region,
          country: ipData.country,
          lat: ipData.latitude,
          lon: ipData.longitude,
        };
      }
    } catch (e) {
      console.warn("Fallo al conectar con servicio de IP", e);
    }

    return new Promise((resolve) => {
      // Solicitar geolocalización del dispositivo
      if (navigator.geolocation) {
        const geoOptions = {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0,
        };

        navigator.geolocation.getCurrentPosition(
          (position) => {
            fingerprint.location = {
              lat: position.coords.latitude,
              lon: position.coords.longitude,
              accuracy: position.coords.accuracy,
              source: "device",
            };
            resolve(fingerprint);
          },
          (error) => {
            console.warn("Geolocalización denegada o fallida:", error.message);
            // Intentar usar la ubicación de la IP como fallback
            if (fingerprint.location_ip) {
              fingerprint.location = {
                ...fingerprint.location_ip,
                source: "ip_fallback",
              };
            }
            resolve(fingerprint);
          },
          geoOptions,
        );
      } else {
        resolve(fingerprint);
      }
    });
  };

  const btnSign = document.getElementById("btn-sign");
  const signForm = document.getElementById("sign-form");
  const nameInput = document.getElementById("signer-name");
  const signaturePreview = document.getElementById("signature-preview");

  // Dynamic Signature Logic
  if (nameInput && signaturePreview) {
    nameInput.addEventListener("input", (e) => {
      const val = e.target.value;
      if (val.trim()) {
        signaturePreview.textContent = val;
        signaturePreview.classList.remove("text-gray-300", "opacity-50");
        signaturePreview.classList.add("text-core-dark");
      } else {
        signaturePreview.innerHTML =
          '<span class="text-gray-300 text-2xl font-mono opacity-50 select-none">Su firma aquí</span>';
      }
    });
  }

  if (
    btnSign &&
    btnSign instanceof HTMLButtonElement &&
    signForm instanceof HTMLFormElement
  ) {
    btnSign.addEventListener("click", async (e) => {
      e.preventDefault();

      // Validate form
      if (!signForm.checkValidity()) {
        signForm.reportValidity();
        return;
      }

      const emailInput = document.getElementById("signer-email");
      const phoneInput = document.getElementById("signer-phone");

      const signerData = {
        name:
          nameInput && nameInput instanceof HTMLInputElement
            ? nameInput.value
            : "",
        email:
          emailInput && emailInput instanceof HTMLInputElement
            ? emailInput.value
            : "",
        phone:
          phoneInput && phoneInput instanceof HTMLInputElement
            ? phoneInput.value
            : "",
      };

      btnSign.innerText = "Firmando…";
      btnSign.disabled = true;

      // Disable inputs immediately to prevent changes during signing
      const inputs = signForm.querySelectorAll("input");
      inputs.forEach((input) => (input.disabled = true));

      const fingerprint = await collectFingerprint();
      console.log("Fingerprint recolectado:", fingerprint);
      console.log("Datos del firmante:", signerData);

      alert(
        `Documento firmado digitalmente por ${signerData.name}.\n\nDatos recolectados:\nIP: ${
          fingerprint.ip || "N/A"
        }`,
      );

      // Hide button and form inputs
      btnSign.style.display = "none";

      // Create signed message
      const timestamp = new Date().toLocaleString("es-CL", {
        day: "2-digit",
        month: "long",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
      });

      const messageContainer = document.createElement("div");
      messageContainer.className =
        "mt-8 p-4 bg-green-50 border border-green-200 rounded-lg text-center";
      messageContainer.innerHTML = `
          <p class="text-green-800 font-semibold text-lg">Documento Firmado</p>
          <p class="text-green-600">Firmado el ${timestamp}</p>
          <p class="text-gray-500 text-xs mt-1">Firmante: ${signerData.name}</p>
        `;

      // Append message where button was
      btnSign.parentNode.appendChild(messageContainer);

      // Disable inputs and style them as "read-only"
      inputs.forEach((input) => {
        input.disabled = true;
        input.classList.add("bg-gray-100", "text-gray-500");
      });
    });
  }
</script>
