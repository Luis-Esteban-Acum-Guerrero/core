---
import Layout from "../../layouts/LayoutMenu.astro";
import { menuData } from "./menu.js";
import DataTable from "./components/DataTable.astro";
import CompanyFormComponent from "./company/CompanyFormComponent.astro";

// Datos de ejemplo para empresas
const empresasData = {
  stats: {
    total_empresas: 3,
    activas: 2,
    suspendidas: 1,
    total_usuarios: 24,
  },
  empresas: [
    {
      id: 1,
      rut: "76.123.456-9",
      razon_social: "Tecnología y Servicios SpA",
      nombre_fantasia: "TechServe",
      giro_comercial: "Consultoría Tecnológica",
      direccion: "Av. Providencia 1234",
      ciudad: "Santiago",
      comuna: "Providencia",
      region: "Región Metropolitana",
      email: "contacto@techserve.cl",
      telefono: "+56223456789",
      estado: "activa",
      is_cliente: true,
      is_proveedor: false,
      usuarios_count: 12,
      fecha_creacion: "2024-01-15T10:30:00Z",
    },
    {
      id: 2,
      rut: "11.222.333-4",
      razon_social: "Comercial del Sur Ltda.",
      nombre_fantasia: "SurComercial",
      giro_comercial: "Comercio Minorista",
      direccion: "Calle Sur 567",
      ciudad: "Concepción",
      comuna: "Concepción",
      region: "Bío Bío",
      email: "info@surcomercial.cl",
      telefono: "+56412345678",
      estado: "activa",
      is_cliente: true,
      is_proveedor: true,
      usuarios_count: 8,
      fecha_creacion: "2024-01-10T09:15:00Z",
    },
    {
      id: 3,
      rut: "88.999.000-7",
      razon_social: "Servicios Financieros SA",
      nombre_fantasia: "FinServ",
      giro_comercial: "Servicios Financieros",
      direccion: "Las Condes 890",
      ciudad: "Santiago",
      comuna: "Las Condes",
      region: "Región Metropolitana",
      email: "servicios@finserv.cl",
      telefono: "+56234567890",
      estado: "suspendida",
      is_cliente: false,
      is_proveedor: true,
      usuarios_count: 4,
      fecha_creacion: "2024-01-05T11:00:00Z",
    },
  ],
};

const tableColumns = [
  {
    key: "razon_social",
    label: "Empresa",
    sortable: true,
    visible: true,
    width: "250px",
  },
  {
    key: "rut",
    label: "RUT",
    sortable: true,
    visible: true,
    width: "120px",
  },
  {
    key: "giro_comercial",
    label: "Giro",
    sortable: true,
    visible: true,
    width: "180px",
  },
  {
    key: "region",
    label: "Región",
    sortable: true,
    visible: true,
    width: "150px",
  },
  {
    key: "estado",
    label: "Estado",
    sortable: true,
    visible: true,
    width: "100px",
    type: "badge",
    badgeColors: (value: any) => {
      switch (value) {
        case "activa":
          return "bg-core-primary/20 text-core-dark dark:bg-green-900 dark:text-green-200";
        case "suspendida":
          return "bg-core-gray/20 text-core-dark dark:bg-yellow-900 dark:text-yellow-200";
        case "inactiva":
          return "bg-core-dark/10 text-core-dark dark:bg-red-900 dark:text-red-200";
        default:
          return "bg-core-light text-core-dark dark:bg-core-dark dark:text-gray-200";
      }
    },
  },
  {
    key: "usuarios_count",
    label: "Usuarios",
    sortable: true,
    visible: true,
    width: "100px",
    type: "number",
  },
];

const actionButtons = [
  {
    label: "Editar",
    icon: "M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z",
    action: (item: any) => `window.handleAction('Editar', ${JSON.stringify(item).replace(/"/g, "&quot;")})`,
  },
  {
    label: "Eliminar",
    icon: "M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16",
    class:
      "text-core-dark hover:text-red-900 dark:text-red-400 dark:hover:text-red-300",
    action: (item: any) => `window.handleAction('Eliminar', ${JSON.stringify(item).replace(/"/g, "&quot;")})`,
  },
];
---

<style>
  /* Ocultar botones internos del componente reutilizado para usar los del modal */
  :global(#company-form > .flex.justify-end) {
    display: none !important;
  }
</style>

<Layout menuData={menuData}>
  <div id="content" class="md:ps-0 lg:ps-40 mainmenu-open:pt-10 2xl:hs-overlay-layout-open:pe-2 xl:ps-80 transition-all duration-300">
    <div class="max-w-[85rem] px-4 sm:px-6 lg:px-8 mx-auto">
      <div class="py-2 sm:pb-0 sm:pt-5 space-y-8">
        <!-- Header -->
        <div class="flex flex-wrap justify-between items-center gap-2">
          <div>
            <h1 class="text-lg md:text-xl font-semibold text-core-dark dark:text-neutral-200">
              Gestión de Empresas
            </h1>
            <p class="text-sm text-core-gray dark:text-core-gray">
              Administra las organizaciones registradas y sus perfiles comerciales
            </p>
          </div>
          <div class="flex gap-2">
            <button 
              type="button" 
              onclick="openModal('empresaModal')"
              class="py-2 px-3 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-transparent bg-core-primary text-white hover:opacity-80 focus:outline-hidden focus:opacity-80 disabled:opacity-50 disabled:pointer-events-none"
            >
              <svg class="size-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 5v14M5 12l7 7 7-7"/>
              </svg>
              Nueva Empresa
            </button>
          </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="p-4 bg-core-light border border-core-gray rounded-xl shadow-2xs dark:bg-neutral-800 dark:border-neutral-700">
            <div class="flex items-center gap-3">
              <div class="shrink-0 w-12 h-12 bg-core-primary/20 rounded-lg flex items-center justify-center dark:bg-blue-900">
                <svg class="w-6 h-6 text-core-primary dark:text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
              </div>
              <div>
                <p class="text-xs font-medium text-core-gray dark:text-core-gray">Total Empresas</p>
                <p class="text-xl font-bold text-core-dark dark:text-white">{empresasData.stats.total_empresas}</p>
              </div>
            </div>
          </div>
          <div class="p-4 bg-core-light border border-core-gray rounded-xl shadow-2xs dark:bg-neutral-800 dark:border-neutral-700">
            <div class="flex items-center gap-3">
              <div class="shrink-0 w-12 h-12 bg-core-primary/20 rounded-lg flex items-center justify-center dark:bg-green-900">
                <svg class="w-6 h-6 text-core-primary dark:text-green-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
              </div>
              <div>
                <p class="text-xs font-medium text-core-gray dark:text-core-gray">Activas</p>
                <p class="text-xl font-bold text-core-dark dark:text-white">{empresasData.stats.activas}</p>
              </div>
            </div>
          </div>
          <div class="p-4 bg-core-light border border-core-gray rounded-xl shadow-2xs dark:bg-neutral-800 dark:border-neutral-700">
            <div class="flex items-center gap-3">
              <div class="shrink-0 w-12 h-12 bg-core-gray/20 rounded-lg flex items-center justify-center dark:bg-yellow-900">
                <svg class="w-6 h-6 text-core-gray dark:text-yellow-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
              </div>
              <div>
                <p class="text-xs font-medium text-core-gray dark:text-core-gray">Suspendidas</p>
                <p class="text-xl font-bold text-core-dark dark:text-white">{empresasData.stats.suspendidas}</p>
              </div>
            </div>
          </div>
          <div class="p-4 bg-core-light border border-core-gray rounded-xl shadow-2xs dark:bg-neutral-800 dark:border-neutral-700">
            <div class="flex items-center gap-3">
              <div class="shrink-0 w-12 h-12 bg-core-dark/10 rounded-lg flex items-center justify-center dark:bg-purple-900">
                <svg class="w-6 h-6 text-core-dark dark:text-purple-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
              </div>
              <div>
                <p class="text-xs font-medium text-core-gray dark:text-core-gray">Usuarios Totales</p>
                <p class="text-xl font-bold text-core-dark dark:text-white">{empresasData.stats.total_usuarios}</p>
              </div>
            </div>
          </div>
        </div>

        <DataTable 
          data={empresasData.empresas} 
          columns={tableColumns as any} 
          title="Listado de Empresas"
          searchPlaceholder="Buscar por nombre, RUT o región..."
          actionButtons={actionButtons as any}
        />
      </div>
    </div>
  </div>

  <!-- Modal Empresa -->
  <div id="empresaModal" class="hs-overlay hidden w-full h-full fixed top-0 start-0 z-[80] overflow-x-hidden overflow-y-auto bg-black/50">
    <div class="hs-overlay-open:mt-7 hs-overlay-open:opacity-100 hs-overlay-open:duration-500 mt-0 opacity-0 ease-out transition-all sm:max-w-5xl sm:w-full m-3 sm:mx-auto">
      <div class="bg-core-light border border-core-gray rounded-xl shadow-2xs dark:bg-neutral-800 dark:border-neutral-700">
        <div class="py-3 px-5 border-b border-core-gray dark:border-neutral-700">
          <h3 class="font-semibold text-core-dark dark:text-neutral-200">
            Registrar Nueva Empresa
          </h3>
        </div>
        <div class="p-5">
          <CompanyFormComponent />
        </div>
        <div class="flex justify-end items-center gap-x-2 py-3 px-5 border-t border-core-gray dark:border-neutral-700">
          <button type="button" onclick="closeModal('empresaModal')" class="py-2 px-3 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-core-gray bg-white text-core-dark shadow-2xs hover:bg-core-light focus:outline-hidden focus:bg-core-light disabled:opacity-50 disabled:pointer-events-none dark:bg-neutral-800 dark:border-neutral-700 dark:text-white dark:hover:bg-neutral-700 dark:focus:bg-neutral-700">
            Cancelar
          </button>
          <button type="button" onclick="saveEmpresa()" class="py-2 px-3 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-transparent bg-core-primary text-white hover:opacity-80 focus:outline-hidden focus:opacity-80 disabled:opacity-50 disabled:pointer-events-none">
            Guardar
          </button>
        </div>
    </div>
  </div>

  <script>
    import { FormValidator, validationRules } from './components/ValidationUtils.js';
    let validator: any;
    
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize validator if rules exist
      if (validationRules && validationRules.empresa) {
        validator = new FormValidator(validationRules.empresa);
      }

      // Add submit listener to the form to intercept CompanyFormComponent's button
      const form = document.getElementById('company-form');
      if (form) {
        form.addEventListener('submit', (e) => {
          e.preventDefault();
          (window as any).saveEmpresa();
        });
      }
    });

    (window as any).openModal = function(modalId: string) {
      const modal = document.getElementById(modalId);
      if (!modal) return;
      
      modal.classList.remove('hidden');
      // Animation handling
      const content = modal.querySelector('div');
      if (content) {
          // Force reflow
          void content.offsetWidth;
          requestAnimationFrame(() => {
            content.classList.remove("opacity-0", "mt-0");
            content.classList.add("opacity-100", "mt-7");
          });
      }
      
      document.body.style.overflow = 'hidden';
      // Reset form
      const form = document.getElementById('company-form') as HTMLFormElement;
      if(form) {
        form.reset();
        form.removeAttribute('data-company-id');
        
        // Reset specific fields state
        const rutInput = document.getElementById('company-rut') as HTMLInputElement;
        if(rutInput) {
            rutInput.disabled = false;
            rutInput.value = '';
        }
        
        // Reset checkboxes defaults
        const clientCheck = document.getElementById('is-cliente') as HTMLInputElement;
        const providerCheck = document.getElementById('is-proveedor') as HTMLInputElement;
        if(clientCheck) clientCheck.checked = true;
        if(providerCheck) providerCheck.checked = false;
      }
      
      // Reset title
      const title = modal.querySelector('h3');
      if(title) title.textContent = 'Registrar Nueva Empresa';
    };

    (window as any).closeModal = function(modalId: string) {
      const modal = document.getElementById(modalId);
      if (!modal) return;
      
      const content = modal.querySelector('div');
      if (content) {
          content.classList.remove("opacity-100", "mt-7");
          content.classList.add("opacity-0", "mt-0");
      }
      
      setTimeout(() => {
          modal.classList.add('hidden');
          document.body.style.overflow = 'auto';
      }, 300);
    };

    // Mock API functions
    async function mockPostEmpresa(data: any, uid: string | null = null) {
        console.log(`[MOCK API] POST /api/data/empresas${uid ? '/' + uid : ''}`, data);
        return new Promise(resolve => setTimeout(() => resolve({ success: true, data }), 500));
    }

    async function mockGetEmpresa(uid: string) {
        console.log(`[MOCK API] GET /api/data/empresas/${uid}`);
        return new Promise(resolve => setTimeout(() => resolve({
            success: true,
            data: { id: uid } // Mock return
        }), 300));
    }

    (window as any).saveEmpresa = async function() {
      const form = document.getElementById('company-form') as HTMLFormElement;
      if (!form) return;
      
      const getVal = (id: string) => (document.getElementById(id) as HTMLInputElement)?.value || '';
      const getChecked = (id: string) => (document.getElementById(id) as HTMLInputElement)?.checked || false;

      // Gather data manually since fields are distributed
      const data = {
          datosBasicos: {
              rut: getVal('company-rut'),
              razonSocial: getVal('company-name'),
              giro: getVal('company-activity'),
              email: getVal('company-email'),
              telefono: getVal('company-phone'),
              direccion: getVal('company-address'),
              ciudad: getVal('company-city'),
              comuna: getVal('company-commune'),
          },
          isCliente: getChecked('is-cliente'),
          isProveedor: getChecked('is-proveedor')
      };

      // Validation
      if (validator) {
          const errors = validator.validate(data.datosBasicos);
          if (Object.keys(errors).length > 0) {
              alert(Object.values(errors)[0]);
              return;
          }
      } else if (!data.datosBasicos.rut || !data.datosBasicos.razonSocial || !data.datosBasicos.email) {
          alert('Por favor complete los campos obligatorios (*)');
          return;
      }

      // Check if editing
      const companyId = form.getAttribute('data-company-id');
      
      try {
          await mockPostEmpresa(data, companyId);
          
          (window as any).closeModal('empresaModal');
          (window as any).showToast(`Empresa ${companyId ? 'actualizada' : 'registrada'} exitosamente`, 'success');
          setTimeout(() => location.reload(), 1000);
      } catch (error) {
          console.error('Error saving empresa:', error);
          (window as any).showToast('Error al guardar la empresa', 'error');
      }
    };

    (window as any).showToast = function(message: string, type = 'success') {
      const toast = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-core-primary' : 'bg-red-500';
      toast.className = `fixed top-4 right-4 z-50 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.classList.remove('translate-x-full'), 100);
      setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    };

    (window as any).handleAction = async function(action: string, item: any) {
      if (action === 'Eliminar') {
        if (confirm(`¿Eliminar la empresa ${item.razon_social}?`)) {
          console.log(`[MOCK API] DELETE /api/data/empresas/${item.id}`);
          (window as any).showToast('Empresa eliminada', 'success');
          setTimeout(() => location.reload(), 1000);
        }
      } else if (action === 'Editar') {
        (window as any).openModal('empresaModal');
        
        const modal = document.getElementById('empresaModal');
        if (modal) {
            const title = modal.querySelector('h3');
            if(title) title.textContent = 'Editar Empresa';
        }
        
        const form = document.getElementById('company-form');
        if(form) form.setAttribute('data-company-id', item.id);

        const setVal = (id: string, val: any) => {
            const el = document.getElementById(id) as HTMLInputElement;
            if(el) el.value = val || '';
        };

        const rutInput = document.getElementById('company-rut') as HTMLInputElement;
        if(rutInput) {
            rutInput.value = item.rut;
            rutInput.disabled = true; // Disable RUT in edit mode
        }

        setVal('company-name', item.razon_social);
        setVal('company-activity', item.giro_comercial);
        setVal('company-email', item.email);
        setVal('company-phone', item.telefono);
        setVal('company-address', item.direccion);
        setVal('company-city', item.ciudad);
        setVal('company-commune', item.comuna);
        
        const setChecked = (id: string, val: boolean) => {
            const el = document.getElementById(id) as HTMLInputElement;
            if(el) el.checked = val;
        };
        setChecked('is-cliente', !!item.is_cliente);
        setChecked('is-proveedor', !!item.is_proveedor);
      }
    };
  </script>
</Layout>