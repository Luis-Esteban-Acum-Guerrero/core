---
// DataTable.astro - Componente genÃ©rico de tabla con todas las features
interface Column {
  key: string;
  label: string;
  sortable?: boolean;
  visible?: boolean;
  width?: string;
  type?: 'text' | 'number' | 'date' | 'boolean' | 'badge' | 'actions';
  format?: (value: any) => string;
  badgeColors?: (value: string) => string;
}

interface DataTableProps {
  id?: string;
  data: any[];
  columns: Column[];
  loading?: boolean;
  searchPlaceholder?: string;
  exportable?: boolean;
  title?: string;
  showHeader?: boolean;
  enableColumnToggle?: boolean;
  enableSearch?: boolean;
  enableExport?: boolean;
  actionButtons?: Array<{
    label: string;
    icon: string;
    action: (item: any) => string;
    class?: string;
  }>;
}

type Props = DataTableProps;

const { 
  id = `dt-${Math.random().toString(36).substr(2, 9)}`,
  data = [], 
  columns, 
  loading = false, 
  searchPlaceholder = "Buscar...",
  exportable = true,
  title = "",
  showHeader = true,
  enableColumnToggle = true,
  enableSearch = true,
  enableExport = true,
  actionButtons = []
} = Astro.props;

const wrapperId = `${id}-wrapper`;
---

<div id={wrapperId} class="bg-white border border-core-gray rounded-xl shadow-2xs dark:bg-neutral-800 dark:border-neutral-700">
  <!-- Header -->
  {showHeader && (
    <div class="py-3 px-5 border-b border-core-gray dark:border-neutral-700">
      <div class="flex flex-wrap justify-between items-center gap-2">
        {title && (
          <h2 class="text-lg font-semibold text-core-dark dark:text-neutral-200">
            {title}
          </h2>
        )}
        <div class="flex gap-2">
          <!-- Column Toggle -->
          {enableColumnToggle && (
            <div class="hs-dropdown relative inline-flex">
              <button id={`hs-dropdown-${id}`} type="button" class="hs-dropdown-toggle py-2 px-2.5 inline-flex items-center gap-x-1.5 text-xs font-medium rounded-lg border border-core-gray bg-white text-core-dark shadow-2xs hover:bg-core-light focus:outline-hidden focus:bg-core-light dark:bg-neutral-800 dark:border-neutral-700 dark:text-neutral-300 dark:hover:bg-neutral-700 dark:focus:bg-neutral-700">
                <svg class="shrink-0 size-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="9" y1="9" x2="15" y2="9"></line>
                  <line x1="9" y1="15" x2="15" y2="15"></line>
                </svg>
                Columnas
              </button>
              <div class="hs-dropdown-menu transition-[opacity,margin] duration hs-dropdown-open:opacity-100 opacity-0 hidden z-50 bg-white rounded-xl shadow-xl dark:bg-neutral-900 w-48 p-2" aria-labelledby={`hs-dropdown-${id}`}>
                <div class="space-y-1">
                  {columns.map((col: Column) => (
                    <label class="flex items-center gap-x-2 p-2 text-sm text-core-dark hover:bg-core-light rounded-lg cursor-pointer dark:text-neutral-200 dark:hover:bg-neutral-700">
                      <input 
                        type="checkbox" 
                        class="shrink-0 border-core-gray rounded text-core-dark hover:text-core-primary focus:ring-core-primary dark:bg-neutral-800 dark:border-neutral-600"
                        checked={col.visible !== false}
                        data-column={col.key}
                        onchange={`toggleColumn('${id}', this)`}
                      />
                      <span>{col.label}</span>
                    </label>
                  ))}
                </div>
              </div>
            </div>
          )}
          
          <!-- Export to CSV -->
          {enableExport && (
            <button 
              type="button" 
              onclick={`exportToCSV('${id}')`}
              class="py-2 px-3 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-core-gray bg-white text-core-dark shadow-2xs hover:bg-core-light focus:outline-hidden focus:bg-core-light disabled:opacity-50 disabled:pointer-events-none dark:bg-neutral-800 dark:border-neutral-700 dark:text-white dark:hover:bg-neutral-700 dark:focus:bg-neutral-700"
            >
              <svg class="size-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
              Exportar CSV
            </button>
          )}
        </div>
      </div>
    </div>
  )}

  <!-- Search Bar -->
  {enableSearch && (
    <div class="px-5 py-3 border-b border-core-gray dark:border-neutral-700">
      <div class="relative w-full sm:w-96">
        <input 
          type="text" 
          placeholder={searchPlaceholder}
          onkeyup={`searchTable('${id}', this)`}
          class="py-2 ps-9 pe-3 block w-full border-core-gray rounded-lg text-sm focus:border-core-primary focus:ring-core-primary disabled:opacity-50 disabled:pointer-events-none dark:bg-neutral-800 dark:border-neutral-700 dark:text-core-gray dark:placeholder-neutral-500 dark:focus:ring-neutral-600"
        />
        <svg class="absolute start-3 top-1/2 transform -translate-y-1/2 size-4 text-core-gray dark:text-core-gray" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.35-4.35"/>
        </svg>
      </div>
    </div>
  )}

  <!-- Table Content -->
  <div class="overflow-x-auto">
    {loading ? (
      <div class="p-8">
        <div class="space-y-3">
          {Array.from({ length: 5 }).map(() => (
            <div class="animate-pulse">
              <div class="flex gap-4">
                {columns.map((col: Column) => (
                  <div class={`h-4 bg-core-gray rounded dark:bg-neutral-700 ${col.visible === false ? 'hidden' : ''}`} style={col.width ? `width: ${col.width}` : 'flex: 1'}></div>
                ))}
              </div>
            </div>
          ))}
        </div>
      </div>
    ) : (
      <table class="min-w-full divide-y divide-stone-200 dark:divide-neutral-700" id={id}>
        <thead class="bg-core-light dark:bg-neutral-700">
          <tr>
            {columns.map((col: Column) => (
              <th 
                class={`px-6 py-3 text-left text-xs font-medium text-core-dark/60 uppercase dark:text-core-gray ${col.visible === false ? 'hidden' : ''} ${col.sortable !== false ? 'cursor-pointer hover:bg-core-light dark:hover:bg-neutral-600' : ''}`}
                style={col.width ? `width: ${col.width}` : ''}
                onclick={col.sortable !== false ? `sortTable('${id}', '${col.key}')` : ''}
                data-column={col.key}
              >
                <div class="flex items-center gap-x-1">
                  {col.label}
                  {col.sortable !== false && (
                    <svg class="size-3 text-core-gray" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="m7 15 5-5 5 5"/>
                      <path d="m7 9 5 5 5-5"/>
                    </svg>
                  )}
                </div>
              </th>
            ))}
            {actionButtons.length > 0 && (
              <th class="px-6 py-3 text-right text-xs font-medium text-core-dark/60 uppercase dark:text-core-gray">
                Acciones
              </th>
            )}
          </tr>
        </thead>
        <tbody class="divide-y divide-stone-200 dark:divide-neutral-700">
          {data.map((item: any) => (
            <tr class="hover:bg-core-light dark:hover:bg-neutral-700">
              {columns.map((col: Column) => (
                <td class={`px-6 py-4 whitespace-nowrap text-sm ${col.visible === false ? 'hidden' : ''}`} style={col.width ? `width: ${col.width}` : ''} data-column={col.key}>
                  {(() => {
                    const value = item[col.key];
                    switch (col.type) {
                      case 'badge':
                        const colors = col.badgeColors?.(value) || 'bg-core-light text-core-dark dark:bg-core-dark dark:text-core-light';
                        return (
                          <span class={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${colors}`}>
                            {value}
                          </span>
                        );
                      case 'boolean':
                        return value ? (
                          <svg class="size-5 text-green-500" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 6L9 17l-5-5"/>
                          </svg>
                        ) : (
                          <svg class="size-5 text-core-dark" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="15" y1="9" x2="9" y2="15"/>
                            <line x1="9" y1="9" x2="15" y2="15"/>
                          </svg>
                        );
                      case 'actions':
                        return null; // Actions handled separately
                      case 'date':
                        return new Date(value).toLocaleDateString('es-CL');
                      case 'number':
                        return col.format ? col.format(value) : Number(value).toLocaleString('es-CL');
                      default:
                        return col.format ? col.format(value) : value;
                    }
                  })()}
                </td>
              ))}
              {actionButtons.length > 0 && (
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                  <div class="flex justify-end gap-2">
                    {actionButtons.map((btn: any) => (
                      <button 
                        type="button"
                        onclick={typeof btn.action === 'function' ? btn.action(item) : (typeof btn.action === 'string' ? btn.action : `handleAction('${btn.label}', ${JSON.stringify(item).replace(/'/g, "\\'")})`)}
                        class={`${btn.class || 'text-core-dark hover:text-core-primary hover:text-core-primary dark:text-core-primary dark:hover:text-core-primary'}`}
                      >
                        {btn.icon && (
                          <svg class="size-4 inline mr-1" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <title>{btn.label}</title>
                            {btn.icon}
                          </svg>
                        )}
                        <span class="sr-only">{btn.label}</span>
                      </button>
                    ))}
                  </div>
                </td>
              )}
            </tr>
          ))}
        </tbody>
      </table>
    )}

    {data.length === 0 && !loading && (
      <div class="text-center py-12">
        <svg class="mx-auto size-12 text-core-gray dark:text-neutral-600" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="9" y1="9" x2="15" y2="9"></line>
          <line x1="9" y1="15" x2="15" y2="15"></line>
        </svg>
        <h3 class="mt-2 text-sm font-semibold text-core-dark dark:text-white">No hay datos</h3>
        <p class="mt-1 text-sm text-core-dark/60 dark:text-core-gray">No se encontraron resultados para mostrar.</p>
      </div>
    )}
  </div>
</div>

<script define:vars={{ id, initialData: data, initialColumns: columns.filter(col => col.visible !== false), fullColumns: columns }}>
  // Initialize table store
  window.tableStore = window.tableStore || {};
  window.tableStore[id] = {
    data: initialData,
    columns: initialColumns,
    fullColumns: fullColumns,
    sortDirection: {}
  };
  
  // Column visibility toggle
  window.toggleColumn = function(tableId, checkbox) {
    const columnName = checkbox.dataset.column;
    const store = window.tableStore[tableId];
    if (!store) return;
    
    const table = document.getElementById(tableId);
    if (!table) return;

    const columnIndex = store.columns.findIndex(col => col.key === columnName);
    
    // Find all cells (header and body) with this column attribute WITHIN the specific table
    const cells = table.querySelectorAll(`[data-column="${columnName}"]`);
    
    cells.forEach(cell => {
      cell.style.display = checkbox.checked ? '' : 'none';
    });
    
    // Update column data for export
    if (!checkbox.checked && columnIndex > -1) {
      store.columns.splice(columnIndex, 1);
    } else if (checkbox.checked && columnIndex === -1) {
      const fullColumn = store.fullColumns.find(col => col.key === columnName);
      if (fullColumn) {
        store.columns.push(fullColumn);
      }
    }
  }
  
  // Search functionality
  window.searchTable = function(tableId, input) {
    const searchTerm = input.value.toLowerCase();
    const table = document.getElementById(tableId);
    if (!table) return;
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    
    for (let i = 0; i < rows.length; i++) {
      const row = rows[i];
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(searchTerm) ? '' : 'none';
    }
  }
  
  // Sort functionality
  window.sortTable = function(tableId, columnKey) {
    const table = document.getElementById(tableId);
    if (!table) return;
    
    const store = window.tableStore[tableId];
    const tbody = table.getElementsByTagName('tbody')[0];
    const rows = Array.from(tbody.getElementsByTagName('tr'));
    
    store.sortDirection[columnKey] = store.sortDirection[columnKey] === 'asc' ? 'desc' : 'asc';
    
    rows.sort((a, b) => {
      // Find cells using the data-column attribute
      const aCell = a.querySelector(`td[data-column="${columnKey}"]`);
      const bCell = b.querySelector(`td[data-column="${columnKey}"]`);
      
      const aText = aCell ? aCell.textContent.trim() : '';
      const bText = bCell ? bCell.textContent.trim() : '';
      
      if (store.sortDirection[columnKey] === 'asc') {
        return aText.localeCompare(bText, undefined, {numeric: true});
      } else {
        return bText.localeCompare(aText, undefined, {numeric: true});
      }
    });
    
    rows.forEach(row => tbody.appendChild(row));
    
    // Update sort icons within this table
    table.querySelectorAll('thead th[data-column]').forEach(header => {
      const icon = header.querySelector('svg');
      if (icon) {
        icon.innerHTML = '<path d="m7 15 5-5 5 5"/><path d="m7 9 5 5 5-5"/>';
      }
    });
    
    const currentHeader = table.querySelector(`thead th[data-column="${columnKey}"] svg`);
    if (currentHeader) {
      if (store.sortDirection[columnKey] === 'asc') {
        currentHeader.innerHTML = '<path d="m18 15-6-6-6 6"/>';
      } else {
        currentHeader.innerHTML = '<path d="m6 9 6 6 6-6"/>';
      }
    }
  }
  
  // Export to CSV
  window.exportToCSV = function(tableId) {
    const store = window.tableStore[tableId];
    if (!store) return;
    
    const data = store.data;
    const columns = store.columns;
    
    // Create CSV content
    const headers = columns.map(col => col.label).join(',');
    const rows = data.map(row => 
      columns.map(col => {
        const value = row[col.key];
        if (typeof value === 'string' && value.includes(',')) {
          return `"${value}"`;
        }
        return value;
      }).join(',')
    );
    
    const csvContent = [headers, ...rows].join('\n');
    
    // Create download link
    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `export_${tableId}_${Date.now()}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
</script>
