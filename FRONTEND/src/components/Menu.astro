---
import MenuHead from "./MenuHead.astro";
import MenuSearch from "./MenuSearch.astro";
import MenuGroup from "./MenuGroup.astro";
import MenuItem from "./MenuItem.astro";

const { menuData } = Astro.props;
const currentPath = Astro.url.pathname;
import Icon from "./Icon.jsx";

const allItems = [
  ...menuData.menuItems,
  ...menuData.menuGroups.flatMap((group: any) => group.items),
];

const activeItem = allItems
  .filter(
    (item: any) =>
      item.ruta &&
      (item.ruta === "/" || item.ruta === "/#" || item.ruta === "#"
        ? currentPath === item.ruta
        : currentPath.startsWith(item.ruta)),
  )
  .sort((a: any, b: any) => b.ruta.length - a.ruta.length)[0];
const activeRoute = activeItem ? activeItem.ruta : "";
---

<div
  class="relative sm:w-72 size-full bg-core-light border-x border-core-gray dark:bg-neutral-800 dark:border-neutral-700 overflow-hidden"
>
  <video
    class="absolute inset-0 w-full h-full object-cover opacity-40 pointer-events-none"
    autoplay
    loop
    muted
    playsinline
  >
    <source src="/video/backgroundMenu.mp4" type="video/mp4" />
  </video>

  <div class="relative z-10 h-full flex flex-col">
    <MenuHead {...menuData.menuHead} />
    <MenuSearch {...menuData.menuSearch} class="" />

    <div
      class="h-full flex flex-col overflow-y-auto [&::-webkit-scrollbar]:w-2 [&::-webkit-scrollbar-thumb]:rounded-full [&::-webkit-scrollbar-track]:bg-core-light [&::-webkit-scrollbar-thumb]:bg-core-gray dark:[&::-webkit-scrollbar-track]:bg-neutral-700/50 dark:[&::-webkit-scrollbar-thumb]:bg-neutral-500"
    >
      <div class="p-2 flex flex-col gap-y-0.5">
        {/* Elementos visibles */}
        {
          menuData.menuItems
            .filter((item: any) => item.visible === true)
            .map((item: any) => {
              return item.label === "divider" ? (
                <hr class="my-2 mx-2 border-core-gray/20 dark:border-neutral-800" />
              ) : (
                <MenuItem item={item} isActive={item.ruta === activeRoute} />
              );
            })
        }

        {/* Acordeón 'mostrar más' para elementos ocultos */}
        {
          menuData.menuItems.some((item) => item.visible === false) && (
            <div
              class="hs-accordion"
              id="show-more-accordion99"
              data-hs-accordion="true"
            >
              <button
                type="button"
                class="hs-accordion-toggle flex shrink-0 justify-center items-center gap-x-3 py-1.5 px-3 text-xs text-core-dark/60 rounded-lg hover:bg-core-gray/10 focus:outline-hidden focus:bg-core-gray/10 dark:hover:bg-neutral-700 dark:text-neutral-500 dark:focus:bg-neutral-700"
                aria-controls="show-more-accordion99-sub"
                data-hs-accordion-toggle
              >
                <Icon
                  icon="ChevronRight"
                  className="hs-accordion-active:rotate-90 shrink-0 size-3.5 transition"
                />
                mostrar más...
              </button>

              <div
                id="show-more-accordion99-sub"
                class="hs-accordion-content w-full overflow-hidden transition-[height] duration-300 hidden"
                role="region"
                aria-labelledby="show-more-accordion99"
                data-hs-accordion-content
              >
                <div class="hs-accordion-group mt-0.5 space-y-0.5">
                  {menuData.menuItems
                    .filter((item: any) => item.visible === false)
                    .map((item: any) => {
                      return (
                        <MenuItem
                          item={item}
                          isActive={item.ruta === activeRoute}
                        />
                      );
                    })}
                </div>
              </div>
            </div>
          )
        }
      </div>

      {
        menuData.menuGroups.map((group) => (
          <MenuGroup
            key={group.groupKey}
            {...group}
            currentPath={currentPath}
            activeRoute={activeRoute}
          />
        ))
      }
    </div>
  </div>
</div>
